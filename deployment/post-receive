#!/bin/bash
set -e

echo "ğŸš€ Starting deployment..."

# Configuration
GIT_DIR=/home/admin/apps/cinemyar
GIT_WORK_TREE=/var/www/cinemyar
NGINX_ROOT=/var/www/html
DEPLOY_ENV=${DEPLOY_ENV:-prod}

# Checkout latest code
echo "ğŸ“¦ Checking out code..."
GIT_DIR=$GIT_DIR GIT_WORK_TREE=$GIT_WORK_TREE git checkout -f main

# Navigate to work tree
cd $GIT_WORK_TREE

# Generate environment files
echo "ğŸ”§ Generating environment files..."
pnpm tsx scripts/generate-env.ts

# Install dependencies
echo "ğŸ“¥ Installing dependencies..."
pnpm install --frozen-lockfile

# Build application
echo "ğŸ”¨ Building application..."
pnpm run build

# Deploy to nginx
echo "ğŸš€ Deploying to nginx..."
sudo rm -rf $NGINX_ROOT/*
sudo cp -r dist/* $NGINX_ROOT/

# Restart nginx
echo "ğŸ”„ Restarting nginx..."
sudo systemctl restart nginx

echo "âœ… Deployment complete!"
echo "ğŸŒ App is now live!"
echo "ğŸ“ Environment: $DEPLOY_ENV"
