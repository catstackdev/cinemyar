#!/bin/bash
set -e

echo "🚀 Starting deployment..."

# Configuration
GIT_DIR=/home/admin/apps/cinemyar
GIT_WORK_TREE=/var/www/cinemyar
NGINX_ROOT=/var/www/html
DEPLOY_ENV=${DEPLOY_ENV:-prod}

# Checkout latest code
echo "📦 Checking out code..."
GIT_DIR=$GIT_DIR GIT_WORK_TREE=$GIT_WORK_TREE git checkout -f main

# Navigate to work tree
cd $GIT_WORK_TREE

# Generate environment files
echo "🔧 Generating environment files..."
pnpm tsx scripts/generate-env.ts

# Install dependencies
echo "📥 Installing dependencies..."
pnpm install --frozen-lockfile

# Build application
echo "🔨 Building application..."
pnpm run build

# Deploy to nginx
echo "🚀 Deploying to nginx..."
sudo rm -rf $NGINX_ROOT/*
sudo cp -r dist/* $NGINX_ROOT/

# Restart nginx
echo "🔄 Restarting nginx..."
sudo systemctl restart nginx

echo "✅ Deployment complete!"
echo "🌐 App is now live!"
echo "📝 Environment: $DEPLOY_ENV"
